/*	**********************	CAMBIO DE BASE DE DATOS	******************** */
Use GD1C2016
Go

/*	***********************	CREACION DEL SCHEMA	************************ */
If NOT EXISTS (Select schema_id from sys.schemas where name = 'GESTORES_DEL_AIRE_ACONDICIONADO')
	Execute ('CREATE SCHEMA GESTORES_DEL_AIRE_ACONDICIONADO AUTHORIZATION gd;');
Go

/*	***********************	BORRADO DE TABLAS	************************ */
If exists (Select 'existe' from INFORMATION_SCHEMA.TABLES where TABLE_SCHEMA = 'GESTORES_DEL_AIRE_ACONDICIONADO' AND  TABLE_NAME = 'ft_item')
	Drop table GESTORES_DEL_AIRE_ACONDICIONADO.ft_item
	
If exists (Select 'existe' from INFORMATION_SCHEMA.TABLES where TABLE_SCHEMA = 'GESTORES_DEL_AIRE_ACONDICIONADO' AND  TABLE_NAME = 'ft_factura')
	Drop table GESTORES_DEL_AIRE_ACONDICIONADO.ft_factura
	
If exists (Select 'existe' from INFORMATION_SCHEMA.TABLES where TABLE_SCHEMA = 'GESTORES_DEL_AIRE_ACONDICIONADO' AND  TABLE_NAME = 'dm_forma_pago')
	Drop table GESTORES_DEL_AIRE_ACONDICIONADO.dm_forma_pago

If exists (Select 'existe' from INFORMATION_SCHEMA.TABLES where TABLE_SCHEMA = 'GESTORES_DEL_AIRE_ACONDICIONADO' AND  TABLE_NAME = 'ft_subasta')
	Drop table GESTORES_DEL_AIRE_ACONDICIONADO.ft_subasta

If exists (Select 'existe' from INFORMATION_SCHEMA.TABLES where TABLE_SCHEMA = 'GESTORES_DEL_AIRE_ACONDICIONADO' AND  TABLE_NAME = 'ft_calificacion')
	Drop table GESTORES_DEL_AIRE_ACONDICIONADO.ft_calificacion

If exists (Select 'existe' from INFORMATION_SCHEMA.TABLES where TABLE_SCHEMA = 'GESTORES_DEL_AIRE_ACONDICIONADO' AND  TABLE_NAME = 'ft_compra')
	Drop table GESTORES_DEL_AIRE_ACONDICIONADO.ft_compra

If exists (Select 'existe' from INFORMATION_SCHEMA.TABLES where TABLE_SCHEMA = 'GESTORES_DEL_AIRE_ACONDICIONADO' AND  TABLE_NAME = 'ft_publicacion')
	Drop table GESTORES_DEL_AIRE_ACONDICIONADO.ft_publicacion

If exists (Select 'existe' from INFORMATION_SCHEMA.TABLES where TABLE_SCHEMA = 'GESTORES_DEL_AIRE_ACONDICIONADO' AND  TABLE_NAME = 'dm_rubro')
	Drop table GESTORES_DEL_AIRE_ACONDICIONADO.dm_rubro

If exists (Select 'existe' from INFORMATION_SCHEMA.TABLES where TABLE_SCHEMA = 'GESTORES_DEL_AIRE_ACONDICIONADO' AND  TABLE_NAME = 'dm_tipo_publicacion')
	Drop table GESTORES_DEL_AIRE_ACONDICIONADO.dm_tipo_publicacion

If exists (Select 'existe' from INFORMATION_SCHEMA.TABLES where TABLE_SCHEMA = 'GESTORES_DEL_AIRE_ACONDICIONADO' AND  TABLE_NAME = 'dm_visibilidad')
	Drop table GESTORES_DEL_AIRE_ACONDICIONADO.dm_visibilidad

If exists (Select 'existe' from INFORMATION_SCHEMA.TABLES where TABLE_SCHEMA = 'GESTORES_DEL_AIRE_ACONDICIONADO' AND  TABLE_NAME = 'dm_estado_publicacion')
	Drop table GESTORES_DEL_AIRE_ACONDICIONADO.dm_estado_publicacion

If exists (Select 'existe' from INFORMATION_SCHEMA.TABLES where TABLE_SCHEMA = 'GESTORES_DEL_AIRE_ACONDICIONADO' AND  TABLE_NAME = 'log_ingresos')
	Drop table GESTORES_DEL_AIRE_ACONDICIONADO.log_ingresos	
	
If exists (Select 'existe' from INFORMATION_SCHEMA.TABLES where TABLE_SCHEMA = 'GESTORES_DEL_AIRE_ACONDICIONADO' AND  TABLE_NAME = 'rl_roles_usuarios')
	Drop table GESTORES_DEL_AIRE_ACONDICIONADO.rl_roles_usuarios	
	
If exists (Select 'existe' from INFORMATION_SCHEMA.TABLES where TABLE_SCHEMA = 'GESTORES_DEL_AIRE_ACONDICIONADO' AND  TABLE_NAME = 'rl_funciones_roles')
	Drop table GESTORES_DEL_AIRE_ACONDICIONADO.rl_funciones_roles		
	
If exists (Select 'existe' from INFORMATION_SCHEMA.TABLES where TABLE_SCHEMA = 'GESTORES_DEL_AIRE_ACONDICIONADO' AND  TABLE_NAME = 'dm_funcion')
	Drop table GESTORES_DEL_AIRE_ACONDICIONADO.dm_funcion		
	
If exists (Select 'existe' from INFORMATION_SCHEMA.TABLES where TABLE_SCHEMA = 'GESTORES_DEL_AIRE_ACONDICIONADO' AND  TABLE_NAME = 'dm_rol')
	Drop table GESTORES_DEL_AIRE_ACONDICIONADO.dm_rol		
	
If exists (Select 'existe' from INFORMATION_SCHEMA.TABLES where TABLE_SCHEMA = 'GESTORES_DEL_AIRE_ACONDICIONADO' AND  TABLE_NAME = 'lk_empresa')
	Drop table GESTORES_DEL_AIRE_ACONDICIONADO.lk_empresa	
	
If exists (Select 'existe' from INFORMATION_SCHEMA.TABLES where TABLE_SCHEMA = 'GESTORES_DEL_AIRE_ACONDICIONADO' AND  TABLE_NAME = 'lk_cliente')
	Drop table GESTORES_DEL_AIRE_ACONDICIONADO.lk_cliente	
	
If exists (Select 'existe' from INFORMATION_SCHEMA.TABLES where TABLE_SCHEMA = 'GESTORES_DEL_AIRE_ACONDICIONADO' AND  TABLE_NAME = 'ft_usuario')
	Drop table GESTORES_DEL_AIRE_ACONDICIONADO.ft_usuario	
	
If exists (Select 'existe' from INFORMATION_SCHEMA.TABLES where TABLE_SCHEMA = 'GESTORES_DEL_AIRE_ACONDICIONADO' AND  TABLE_NAME = 'dm_estado_usuario')
	Drop table GESTORES_DEL_AIRE_ACONDICIONADO.dm_estado_usuario

If exists (Select 'existe' from INFORMATION_SCHEMA.TABLES where TABLE_SCHEMA = 'GESTORES_DEL_AIRE_ACONDICIONADO' AND  TABLE_NAME = 'dm_tipo_costo')
	Drop table GESTORES_DEL_AIRE_ACONDICIONADO.dm_tipo_costo

/*	***********************	CREACION DE TABLAS	************************ */
Create Table GESTORES_DEL_AIRE_ACONDICIONADO.dm_tipo_costo
(	
	 id_tipo_costo int identity(1,1)
	,desc_tipo_costo nvarchar(100)
	,primary key (id_tipo_costo)
)

Create Table GESTORES_DEL_AIRE_ACONDICIONADO.dm_estado_usuario
(	
	 id_estado_usuario int identity(1,1)
	,desc_estado nvarchar(100)
	,primary key (id_estado_usuario)
)

Create Table GESTORES_DEL_AIRE_ACONDICIONADO.ft_usuario
(	 
	 id_usuario int identity(1,1)
	,desc_username nvarchar(250)
	,desc_password varbinary(32)
	,id_estado int
	,primary key (id_usuario)
	,foreign key (id_estado) references GESTORES_DEL_AIRE_ACONDICIONADO.dm_estado_usuario(id_estado_usuario)
)

Create Table GESTORES_DEL_AIRE_ACONDICIONADO.lk_cliente
(	
	 id_cliente int identity(1,1)
	,id_usuario int
	,desc_Apellido nvarchar(255)
	,desc_Nombre nvarchar(255)
	,desc_Dni numeric(18,0)
	,desc_Mail nvarchar(255)
	,desc_Dom_Calle nvarchar(255)
	,desc_Nro_Calle numeric(18,0)
	,desc_Piso numeric(18,0)
	,desc_Depto nvarchar(50)
	,desc_Localidad nvarchar(45)
	,desc_Cod_Postal nvarchar(50)
	,desc_Telefono numeric(10,0)
	,desc_Fecha_Nac datetime
	,primary key (id_cliente)	
	,foreign key (id_usuario) references GESTORES_DEL_AIRE_ACONDICIONADO.ft_usuario(id_usuario)
)

Create Table GESTORES_DEL_AIRE_ACONDICIONADO.lk_empresa
(
	 id_empresa int identity(1,1)
	,id_usuario int
	,desc_Razon_Social nvarchar(255)
	,desc_Mail nvarchar(50)
	,desc_Telefono numeric(10,0)
	,desc_Fecha_Creacion datetime
	,desc_Dom_Calle nvarchar(100)
	,desc_Nro_Calle numeric(18,0)
	,desc_Piso numeric(18,0)
	,desc_Depto nvarchar(50)
	,desc_Localidad nvarchar(45)
	,desc_Cod_Postal nvarchar(50)
	,desc_Ciudad nvarchar(45)
	,desc_Cuit nvarchar(50)
	,desc_nombre_contacto nvarchar(100)
	,primary key (id_empresa)
	,foreign key (id_usuario) references GESTORES_DEL_AIRE_ACONDICIONADO.ft_usuario(id_usuario)
)

Create Table GESTORES_DEL_AIRE_ACONDICIONADO.dm_rol
(
	 id_rol int identity(1,1)
	,desc_rol nvarchar(50)
	,estado_rol nvarchar(2)
	,primary key (id_rol)
)

Create Table GESTORES_DEL_AIRE_ACONDICIONADO.dm_funcion
(
	 id_funcion int identity(1,1)
	,desc_funcion nvarchar(200)
	,primary key (id_funcion)
)

Create Table GESTORES_DEL_AIRE_ACONDICIONADO.rl_funciones_roles
(
	 id_rol int
	,id_funcion int
	,foreign key (id_rol) references GESTORES_DEL_AIRE_ACONDICIONADO.dm_rol(id_rol)
	,foreign key (id_funcion) references GESTORES_DEL_AIRE_ACONDICIONADO.dm_funcion(id_funcion)
) 

Create Table GESTORES_DEL_AIRE_ACONDICIONADO.rl_roles_usuarios
(
	 id_usuario int
	,id_rol int
	,foreign key (id_usuario) references GESTORES_DEL_AIRE_ACONDICIONADO.ft_usuario(id_usuario)
	,foreign key (id_rol) references GESTORES_DEL_AIRE_ACONDICIONADO.dm_rol(id_rol)
)

Create Table GESTORES_DEL_AIRE_ACONDICIONADO.log_ingresos
(
	 id_usuario int --En caso de corresponder
	,desc_fecha_log datetime
	,foreign key (id_usuario) references GESTORES_DEL_AIRE_ACONDICIONADO.ft_usuario(id_usuario)
)

Create Table GESTORES_DEL_AIRE_ACONDICIONADO.dm_estado_publicacion
(
	 id_estado_publi int identity(1,1)
	,desc_estado nvarchar(100)
	,primary key (id_estado_publi)
)

Create Table GESTORES_DEL_AIRE_ACONDICIONADO.dm_visibilidad
(
	 id_visibilidad int identity(1,1)
	,desc_codigo numeric(18,0)
	,desc_tipo nvarchar(255)
	,desc_precio numeric(18,2)
	,desc_porcentaje numeric(18,2)
	,desc_porcentaje_envio numeric(18,2)
	,desc_estado bit DEFAULT 1
	,primary key (id_visibilidad)
)

Create Table GESTORES_DEL_AIRE_ACONDICIONADO.dm_tipo_publicacion
(
	 id_tipo_publi int identity(1,1)
	,desc_tipo_public nvarchar(255)
	,primary key (id_tipo_publi)
)

Create Table GESTORES_DEL_AIRE_ACONDICIONADO.dm_rubro
(
	 id_rubro int identity(1,1)
	,desc_rubro nvarchar(255)
	,primary key (id_rubro)
)

Create Table GESTORES_DEL_AIRE_ACONDICIONADO.ft_publicacion
(
	 id_publicacion numeric(18,0)
	,desc_publicacion nvarchar(255)
	,desc_stock numeric(18,0)
	,desc_fecha_publi datetime
	,desc_fecha_venc datetime
	,desc_precio numeric(18,2)
	,desc_costo_envio numeric(18,2)
	,id_estado_publi int
	,id_visibilidad int
	,id_tipo_publi int
	,id_rubro int
	,id_usuario int
	,primary key (id_publicacion)
	,foreign key (id_estado_publi) references GESTORES_DEL_AIRE_ACONDICIONADO.dm_estado_publicacion(id_estado_publi)
	,foreign key (id_visibilidad) references GESTORES_DEL_AIRE_ACONDICIONADO.dm_visibilidad(id_visibilidad)
	,foreign key (id_tipo_publi) references GESTORES_DEL_AIRE_ACONDICIONADO.dm_tipo_publicacion(id_tipo_publi)
	,foreign key (id_rubro) references GESTORES_DEL_AIRE_ACONDICIONADO.dm_rubro(id_rubro)
	,foreign key (id_usuario) references GESTORES_DEL_AIRE_ACONDICIONADO.ft_usuario(id_usuario)
)

Create Table GESTORES_DEL_AIRE_ACONDICIONADO.ft_compra
(
	 id_compra int identity(1,1)
	,desc_fecha datetime
	,desc_cantidad numeric(18,0)
	,id_publicacion numeric(18,0)
	,id_usuario int
	,primary key (id_compra)
	,foreign key (id_publicacion) references GESTORES_DEL_AIRE_ACONDICIONADO.ft_publicacion(id_publicacion)
	,foreign key (id_usuario) references GESTORES_DEL_AIRE_ACONDICIONADO.ft_usuario(id_usuario)
)

Create Table GESTORES_DEL_AIRE_ACONDICIONADO.ft_subasta
(	
	 id_subasta int identity(1,1)
	,desc_fecha datetime
	,desc_monto numeric(18,2)
	,id_publicacion numeric(18,0)
	,id_usuario int
	,primary key (id_subasta)
	,foreign key (id_publicacion) references GESTORES_DEL_AIRE_ACONDICIONADO.ft_publicacion(id_publicacion)
	,foreign key (id_usuario) references GESTORES_DEL_AIRE_ACONDICIONADO.ft_usuario(id_usuario)
)

Create Table GESTORES_DEL_AIRE_ACONDICIONADO.ft_calificacion
(
	 id_calificacion int identity(1,1)
	,desc_codigo numeric(18,0)
	,desc_cantidad_estrellas numeric(18,0)
	,descripcion nvarchar(255)
	,id_usuario int
	,id_compra int
	,primary key (id_calificacion)
	,foreign key (id_usuario) references GESTORES_DEL_AIRE_ACONDICIONADO.ft_usuario(id_usuario)
	,foreign key (id_compra) references GESTORES_DEL_AIRE_ACONDICIONADO.ft_compra(id_compra)
)

Create Table GESTORES_DEL_AIRE_ACONDICIONADO.dm_forma_pago
(
	 id_forma_pago int identity(1,1)
	,desc_tipo_pago nvarchar(255)
	,primary key (id_forma_pago)
)

Create Table GESTORES_DEL_AIRE_ACONDICIONADO.ft_factura
(	
	 id_factura numeric(18,0)
	,desc_factura_nro NUMERIC(18,0) -- HABRIA QUE AGREGARLE LOS DATOS
	,desc_fecha datetime
	,desc_total numeric(18,2)
	,id_forma_pago int
	,id_usuario int
	,primary key (id_factura)
	,foreign key (id_forma_pago) references GESTORES_DEL_AIRE_ACONDICIONADO.dm_forma_pago(id_forma_pago)
	,foreign key (id_usuario) references GESTORES_DEL_AIRE_ACONDICIONADO.ft_usuario(id_usuario)
)

Create Table GESTORES_DEL_AIRE_ACONDICIONADO.ft_item	
(
	 id_item int identity(1,1)
	,desc_item_monto numeric(18,2)
	,desc_item_cant numeric(18,0)
	,id_factura numeric(18,0)
	,id_publicacion numeric(18,0)
	,id_tipo_costo int
	,primary key (id_item)
	,foreign key (id_factura) references GESTORES_DEL_AIRE_ACONDICIONADO.ft_factura(id_factura)
	,foreign key (id_tipo_costo) references GESTORES_DEL_AIRE_ACONDICIONADO.dm_tipo_costo(id_tipo_costo)
	,foreign key (id_publicacion) references GESTORES_DEL_AIRE_ACONDICIONADO.ft_publicacion(id_publicacion)
)
Go

/*	***********************	BORRADO DE VISTAS	************************ */
If exists (select * FROM sys.views where name = 'rol_usuario')
Drop view GESTORES_DEL_AIRE_ACONDICIONADO.rol_usuario
Go

If exists (select * FROM sys.views where name = 'rol_funcionalidades')
Drop view GESTORES_DEL_AIRE_ACONDICIONADO.rol_funcionalidades
Go

If exists (select * FROM sys.views where name = 'publicaciones')
Drop view GESTORES_DEL_AIRE_ACONDICIONADO.publicaciones
Go

/*	***********************	CREACION DE VISTAS	************************ */
Create view GESTORES_DEL_AIRE_ACONDICIONADO.rol_usuario
As
Select usu.*, rol.desc_rol, rol.estado_rol from GESTORES_DEL_AIRE_ACONDICIONADO.rl_roles_usuarios usu
left join GESTORES_DEL_AIRE_ACONDICIONADO.dm_rol rol
	on usu.id_rol = rol.id_rol
Go

Create view GESTORES_DEL_AIRE_ACONDICIONADO.rol_funcionalidades
As
Select rol.desc_rol, fu.desc_funcion
From GESTORES_DEL_AIRE_ACONDICIONADO.rl_funciones_roles rl
left join GESTORES_DEL_AIRE_ACONDICIONADO.dm_rol rol
	on rl.id_rol = rol.id_rol
left join GESTORES_DEL_AIRE_ACONDICIONADO.dm_funcion fu
	on rl.id_funcion = fu.id_funcion
Go

Create view GESTORES_DEL_AIRE_ACONDICIONADO.publicaciones
As
Select	 pub.id_publicacion
		,pub.desc_publicacion
		,pub.desc_stock
		,pub.desc_precio
		,pub.desc_costo_envio
		,cast(pub.desc_fecha_publi as date) as fecha_publicacion
		,cast(pub.desc_fecha_venc as date) as fecha_vencimiento
		,rub.desc_rubro
		,vis.desc_tipo
		,est.desc_estado
		,tip.desc_tipo_public
		,pub.id_usuario
from GESTORES_DEL_AIRE_ACONDICIONADO.ft_publicacion pub
left join GESTORES_DEL_AIRE_ACONDICIONADO.dm_rubro rub
	on pub.id_rubro = rub.id_rubro
left join GESTORES_DEL_AIRE_ACONDICIONADO.dm_visibilidad vis
	on pub.id_visibilidad = vis.id_visibilidad
left join GESTORES_DEL_AIRE_ACONDICIONADO.dm_estado_publicacion est
	on pub.id_estado_publi = est.id_estado_publi
left join GESTORES_DEL_AIRE_ACONDICIONADO.dm_tipo_publicacion tip
	on pub.id_tipo_publi = tip.id_tipo_publi
Go

/*	***********************	CARGA DE DATOS	************************ */
--Carga de los tipos de costos
Insert into GESTORES_DEL_AIRE_ACONDICIONADO.dm_tipo_costo	(desc_tipo_costo)
Values	('No informado'),
		('Costo por publicacion'),
		('Costo por envio'),
		('Costo por venta')
Go

--Carga de los roles
Insert into GESTORES_DEL_AIRE_ACONDICIONADO.dm_rol	(desc_rol, estado_rol)
Values	('Cliente', 'H'),
		('Empresa', 'H'),
		('Administrador', 'H')
Go

--Carga de las funciones
Insert into GESTORES_DEL_AIRE_ACONDICIONADO.dm_funcion	(desc_funcion)
Values	('ABM de Rol'),
		('ABM de Usuarios'),
		('ABM de Rubro'),
		('ABM visibilidad de publicación'),
		('Generar Publicación'),
		('Comprar/Ofertar'),
		('Historial del cliente'),
		('Calificar al Vendedor'),
		('Consulta de facturas realizadas al vendedor'),
		('Listado Estadístico')
Go

--Carga de los estados de las publicaciones
Insert into GESTORES_DEL_AIRE_ACONDICIONADO.dm_estado_publicacion	(desc_estado)
Values	('Borrador'),
		('Publicada'),
		('Pausada'),
		('Finalizada')
Go

--Carga de los estados de los usuarios
Insert into GESTORES_DEL_AIRE_ACONDICIONADO.dm_estado_usuario	(desc_estado)
Values	('Habilitado'),
		('Bloqueado')
Go

--Carga de las formas de pago
Insert Into GESTORES_DEL_AIRE_ACONDICIONADO.dm_forma_pago	(desc_tipo_pago)
Select distinct Forma_Pago_Desc 
From gd_esquema.Maestra
Where Forma_Pago_Desc is not null

--Carga de los rubros
Insert Into GESTORES_DEL_AIRE_ACONDICIONADO.dm_rubro	(desc_rubro)
Select Distinct Publicacion_Rubro_Descripcion 
From gd_esquema.Maestra
Where Publicacion_Rubro_Descripcion is not null

--Carga de los tipos de publicaciones
Insert Into GESTORES_DEL_AIRE_ACONDICIONADO.dm_tipo_publicacion	(desc_tipo_public)
Select Distinct Publicacion_Tipo
From gd_esquema.Maestra
Where Publicacion_Tipo is not null

--Carga de los tipos de visualizaciones de las publicaciones
Insert Into GESTORES_DEL_AIRE_ACONDICIONADO.dm_visibilidad	(	 desc_codigo
																,desc_tipo
																,desc_precio
																,desc_porcentaje
																,desc_porcentaje_envio	)
Select	 Distinct
		 Publicacion_Visibilidad_Cod
		,Publicacion_Visibilidad_Desc
		,Publicacion_Visibilidad_Precio
		,Publicacion_Visibilidad_Porcentaje
		,Publicacion_Visibilidad_Porcentaje/2
From gd_esquema.Maestra
Where Publicacion_Visibilidad_Cod is not null

--Carga de las relaciones entre los roles y las funciones
Insert into GESTORES_DEL_AIRE_ACONDICIONADO.rl_funciones_roles	(	 id_rol
																	,id_funcion	)
Values	(1,5), (1,6), (1,7), (1,8), (1,9), (1,10),	 
		(2,5), (2,7), (2,8), (2,9), (2,10),
		(3,1), (3,2), (3,3), (3,4), (3,5), (3,6), (3,7), (3,8), (3,9), (3,10)
Go

--Migracion de clientes, empresas y usuarios
--Creacion de tabla auxiliar para procesamiento
Create Table #usuarios	(	 id int identity(1,1)
							,username nvarchar(255)
							,password varbinary(32)
							,status int
							,entidad varchar(50)
							,id_entidad varchar(75)	)

Insert Into #usuarios 	(	 username
							,password
							,status
							,entidad
							,id_entidad	)
Select	 Distinct
		 left(Replace(Publ_Cli_Mail, ' ', ''), CHARINDEX('@', Replace(Publ_Cli_Mail, ' ', '')) - 1)
		,hashbytes('sha2_256', left(Replace(Publ_Cli_Mail, ' ', ''), CHARINDEX('@', Replace(Publ_Cli_Mail, ' ', '')) - 1))
		,1
		,'Cliente'
		,Publ_Cli_Dni
From gd_esquema.Maestra
Where Publ_Cli_Dni is not null

Insert Into #usuarios 	(	 username
							,password
							,status
							,entidad
							,id_entidad	)
Select	 Distinct
		 concat('razon', right(Publ_Empresa_Razon_Social, len(Publ_Empresa_Razon_Social) - CHARINDEX(':', Publ_Empresa_Razon_Social)))
		,hashbytes('sha2_256', concat('razon', right(Publ_Empresa_Razon_Social, len(Publ_Empresa_Razon_Social) - CHARINDEX(':', Publ_Empresa_Razon_Social))))
		,1
		,'Empresa'
		,Publ_Empresa_Cuit
From gd_esquema.Maestra
Where Publ_Empresa_Cuit is not null

--Creacion de indice para optimizacion de matcheos
Create Index index_id_entidad on #Usuarios(id_entidad)

--Carga de usuarios
Insert into GESTORES_DEL_AIRE_ACONDICIONADO.ft_usuario	(	 desc_username
															,desc_password
															,id_estado	)
Select	 username
		,password
		,status
From #usuarios

--Carga de clientes
Insert Into GESTORES_DEL_AIRE_ACONDICIONADO.lk_cliente	(	 id_usuario
															,desc_Apellido
															,desc_Nombre
															,desc_Dni
															,desc_Mail
															,desc_Dom_Calle
															,desc_Nro_Calle
															,desc_Piso
															,desc_Depto
															,desc_Cod_Postal
															,desc_Fecha_Nac	)
Select	 Distinct
		 us.id
		,ma.Publ_Cli_Apeliido
		,ma.Publ_Cli_Nombre
		,ma.Publ_Cli_Dni
		,ma.Publ_Cli_Mail
		,ma.Publ_Cli_Dom_Calle
		,ma.Publ_Cli_Nro_Calle
		,ma.Publ_Cli_Piso
		,ma.Publ_Cli_Depto
		,ma.Publ_Cli_Cod_Postal
		,ma.Publ_Cli_Fecha_Nac
From gd_esquema.Maestra ma
inner join #usuarios us
	on convert(varchar(75), ma.Publ_Cli_Dni) = us.id_entidad
Where	ma.Publ_Cli_Dni is not null
	and us.entidad = 'Cliente'

--Carga de las empresas
Insert Into GESTORES_DEL_AIRE_ACONDICIONADO.lk_empresa	(	 id_usuario
															,desc_Razon_Social
															,desc_Mail
															,desc_Fecha_Creacion
															,desc_Dom_Calle
															,desc_Nro_Calle
															,desc_Piso
															,desc_Depto
															,desc_Cod_Postal
															,desc_Cuit	)
Select	 Distinct
		 us.id
		,Publ_Empresa_Razon_Social
		,Publ_Empresa_Mail
		,Publ_Empresa_Fecha_Creacion
		,Publ_Empresa_Dom_Calle
		,Publ_Empresa_Nro_Calle
		,Publ_Empresa_Piso
		,Publ_Empresa_Depto
		,Publ_Empresa_Cod_Postal
		,Publ_Empresa_Cuit
From gd_esquema.Maestra ma
inner join #usuarios us
	on ma.Publ_Empresa_Cuit = us.id_entidad
Where	ma.Publ_Empresa_Cuit is not null
	and us.entidad = 'Empresa'

--Asignacion de los roles en base a tipo de usuario
Insert Into GESTORES_DEL_AIRE_ACONDICIONADO.rl_roles_usuarios	(	 id_usuario
																	,id_rol	)
Select	 id
		,case entidad when 'Cliente' then 1 else 2 end
From #usuarios

--Migracion de las publicaciones
Insert into GESTORES_DEL_AIRE_ACONDICIONADO.ft_publicacion	(	 id_publicacion
																,desc_publicacion
																,desc_stock
																,desc_fecha_publi
																,desc_fecha_venc
																,desc_precio
																,desc_costo_envio
																,id_estado_publi
																,id_visibilidad
																,id_tipo_publi
																,id_rubro
																,id_usuario	)
Select	 Distinct
		 ma.Publicacion_Cod
		,ma.Publicacion_Descripcion
		,ma.Publicacion_Stock
		,ma.Publicacion_Fecha
		,ma.Publicacion_Fecha_Venc
		,ma.Publicacion_Precio
		,0
		,es.id_estado_publi
		,vi.id_visibilidad
		,publ_tipo.id_tipo_publi
		,ru.id_rubro
		,us.id
From gd_esquema.Maestra ma
inner join #usuarios us
	on isnull(Convert(varchar(50), ma.Publ_Cli_Dni), ma.Publ_Empresa_Cuit) = us.id_entidad
inner join GESTORES_DEL_AIRE_ACONDICIONADO.dm_tipo_publicacion publ_tipo
	on ma.Publicacion_Tipo = publ_tipo.desc_tipo_public
inner join GESTORES_DEL_AIRE_ACONDICIONADO.dm_visibilidad vi
	on ma.Publicacion_Visibilidad_Cod = vi.desc_codigo
inner join GESTORES_DEL_AIRE_ACONDICIONADO.dm_estado_publicacion es
	on ma.Publicacion_Estado = es.desc_estado
inner join GESTORES_DEL_AIRE_ACONDICIONADO.dm_rubro ru
	on ma.Publicacion_Rubro_Descripcion = ru.desc_rubro
Where Publicacion_Cod is not null

--Creacion de tabla auxiliar para procesamiento de compras
Create table #compra	(	 id int identity(1,1)
							,fecha datetime
							,cantidad numeric(18,0)
							,publicacion int
							,usuario int	
							,calificacion varchar(75)	)

--Migracion de las compras
Insert into #compra	(	 fecha
						,cantidad
						,publicacion
						,usuario
						,calificacion	)
Select	 Distinct
		 ma.Compra_Fecha
		,ma.Compra_Cantidad
		,pu.id_publicacion
		,us.id
		,ma.Calificacion_Codigo
From gd_esquema.Maestra ma
inner join GESTORES_DEL_AIRE_ACONDICIONADO.ft_publicacion pu
	on ma.Publicacion_Cod = pu.id_publicacion
inner join #usuarios us
	on Convert(varchar(75), ma.Cli_Dni) = us.id_entidad
Where ma.Compra_Fecha is not null


Insert into GESTORES_DEL_AIRE_ACONDICIONADO.ft_compra	(	 desc_fecha
															,desc_cantidad
															,id_publicacion
															,id_usuario	)
Select	 fecha
		,cantidad
		,publicacion
		,usuario
From #compra

--Migracion de las calificaciones
insert into GESTORES_DEL_AIRE_ACONDICIONADO.ft_calificacion	(	 desc_codigo
																,desc_cantidad_estrellas
																,descripcion
																,id_usuario
																,id_compra	)
Select	 Distinct
		 ma.Calificacion_Codigo
		,ma.Calificacion_Cant_Estrellas
		,ma.Calificacion_Descripcion
		,us.id
		,co.id
From gd_esquema.Maestra ma
inner join #usuarios us
	on isnull(Convert(nvarchar(75), ma.Publ_Cli_Dni), ma.Publ_Empresa_Cuit) = us.id_entidad
left join #compra co
	on ma.Calificacion_Codigo = co.calificacion
Where ma.Calificacion_Codigo is not null

--Migracion de las ofertas para subastas
Insert into GESTORES_DEL_AIRE_ACONDICIONADO.ft_subasta	(	 desc_fecha
															,desc_monto
															,id_publicacion
															,id_usuario	)
Select	 Distinct
		 ma.Oferta_Fecha
		,ma.Oferta_Monto
		,pu.id_publicacion
		,us.id
From gd_esquema.Maestra ma
inner join #usuarios us
	on Convert(varchar(75), ma.Cli_Dni) = us.id_entidad
inner join GESTORES_DEL_AIRE_ACONDICIONADO.ft_publicacion pu
	on ma.Publicacion_Cod = pu.id_publicacion
Where	Oferta_Monto is not null

--Migracion de las facturas
Insert into GESTORES_DEL_AIRE_ACONDICIONADO.ft_factura	(	 id_factura
															,desc_fecha
															,desc_total
															,id_forma_pago
															,id_usuario	)
Select	 Distinct
		 ma.Factura_Nro
		,ma.Factura_Fecha
		,ma.Factura_Total
		,fo.id_forma_pago
		,us.id
From gd_esquema.Maestra ma
inner join GESTORES_DEL_AIRE_ACONDICIONADO.dm_forma_pago fo
	on ma.Forma_Pago_Desc = fo.desc_tipo_pago
inner join #usuarios us
	on isnull(Convert(varchar(75), ma.Publ_Cli_Dni), ma.Publ_Empresa_Cuit) = us.id_entidad

--Migracion de Items
Insert into GESTORES_DEL_AIRE_ACONDICIONADO.ft_item	(	 desc_item_monto
														,desc_item_cant
														,id_factura
														,id_publicacion
														,id_tipo_costo	)
Select	 Distinct
		 ma.Item_Factura_Monto
		,ma.Item_Factura_Cantidad
		,ma.Factura_Nro
		,pu.id_publicacion
		,1
From gd_esquema.Maestra ma
inner join GESTORES_DEL_AIRE_ACONDICIONADO.ft_publicacion pu
	on ma.Publicacion_Cod = pu.id_publicacion
Go

--Elimino las tablas temporales
Drop table #compra
Drop table #usuarios

--COMIENZO DE CREACION DE STORE PROCEDURES, FUNCTIONS AND TRIGGERS
/* ELIMINO STORED PROCEDURES SI EXISTEN */
If exists (select'existe' From INFORMATION_SCHEMA.ROUTINES where SPECIFIC_NAME = 'crear_usuario_cliente')
	Drop procedure GESTORES_DEL_AIRE_ACONDICIONADO.crear_usuario_cliente
Go

If exists (select'existe' From INFORMATION_SCHEMA.ROUTINES where SPECIFIC_NAME = 'crear_usuario_empresa')
	Drop procedure GESTORES_DEL_AIRE_ACONDICIONADO.crear_usuario_empresa
Go

If exists (select'existe' From INFORMATION_SCHEMA.ROUTINES where SPECIFIC_NAME = 'logearse')
	Drop procedure GESTORES_DEL_AIRE_ACONDICIONADO.logearse
Go

If exists (select'existe' From INFORMATION_SCHEMA.ROUTINES where SPECIFIC_NAME = 'guardar_publicacion')
	Drop procedure GESTORES_DEL_AIRE_ACONDICIONADO.guardar_publicacion
Go

If exists (select 'existe' From sys.objects where type = 'TR' AND name = 'controlar_ingresos')
	Drop trigger GESTORES_DEL_AIRE_ACONDICIONADO.controlar_ingresos
Go

If exists (select 'existe' From sys.objects where type = 'TR' AND name = 'sumar_total')
	Drop trigger GESTORES_DEL_AIRE_ACONDICIONADO.sumar_total
Go

If exists (select'existe' From INFORMATION_SCHEMA.ROUTINES where SPECIFIC_NAME = 'comprar_subastar')
	Drop procedure GESTORES_DEL_AIRE_ACONDICIONADO.comprar_subastar
Go

/* STORED PROCEDURE PARA GENERAR OFERTAS Y COMPRAS*/
CREATE procedure GESTORES_DEL_AIRE_ACONDICIONADO.comprar_subastar	(	 @desc_fecha varchar(30)
																		,@monto decimal(18,2)
																		,@publicacion int
																		,@usuario int
																		,@tipo_publicacion varchar(50)
																		,@cantidad int	)
As
if @tipo_publicacion = 'Compra Inmediata'
begin
	Insert into GESTORES_DEL_AIRE_ACONDICIONADO.ft_compra	(	 desc_fecha
																,desc_cantidad
																,id_publicacion
																,id_usuario	)
	Select	 CONVERT(datetime, right(@desc_fecha, 4) + SUBSTRING(@desc_fecha, 3, 4) + left(@desc_fecha, 2))
			,@cantidad
			,@publicacion
			,@usuario
end
else
begin
	Insert into GESTORES_DEL_AIRE_ACONDICIONADO.ft_subasta	(	 desc_fecha
																,desc_monto
																,id_publicacion
																,id_usuario	)
	Select	 CONVERT(datetime, right(@desc_fecha, 4) + SUBSTRING(@desc_fecha, 3, 4) + left(@desc_fecha, 2))
			,@monto
			,@publicacion
			,@usuario
end

Go

/* STORED PROCEDURE PARA CREAR UN NUEVO CLIENTE (CARGA TABLAS USUARIO, CLIENTE, Y ROLES_USUARIO)*/
Create Procedure GESTORES_DEL_AIRE_ACONDICIONADO.guardar_publicacion	(	 @id_publicacion varchar(50)
																			,@descripcion varchar(250)
																			,@stock varchar(20)
																			,@fecha_pub varchar(15)
																			,@fecha_venc varchar(15)
																			,@precio varchar(20)
																			,@precio_envio varchar(20)
																			,@estado varchar(50)
																			,@visualizacion varchar(50)
																			,@tipo_publicacion varchar(30)
																			,@rubro varchar(100)
																			,@usuario varchar(10)	)
As
Delete from GESTORES_DEL_AIRE_ACONDICIONADO.ft_publicacion
Where id_publicacion = CONVERT(numeric(18,0), @id_publicacion)

Insert into GESTORES_DEL_AIRE_ACONDICIONADO.ft_publicacion	(	 id_publicacion
																,desc_publicacion
																,desc_stock
																,desc_fecha_publi
																,desc_fecha_venc
																,desc_precio
																,desc_costo_envio
																,id_estado_publi
																,id_visibilidad
																,id_tipo_publi
																,id_rubro
																,id_usuario	)
Select	 CONVERT(numeric(18,0), @id_publicacion)
		,@descripcion
		,case when isnumeric(@stock) = 1 then CONVERT(numeric(18,0), @stock)
							else 0
							end
		,CONVERT(date, right(@fecha_pub, 4) + SUBSTRING(@fecha_pub, 3, 4) + left(@fecha_pub, 2))
		,CONVERT(date, right(@fecha_venc, 4) + SUBSTRING(@fecha_venc, 3, 4) + left(@fecha_venc, 2))
		,case when isnumeric(@precio) = 1 then CONVERT(numeric(18,2), @precio)
							else 0
							end
		,case when isnumeric(@precio_envio) = 1 then CONVERT(numeric(18,2), @precio_envio)
							else 0
							end
		,(Select id_estado_publi 
				from GESTORES_DEL_AIRE_ACONDICIONADO.dm_estado_publicacion
				where desc_estado = @estado)
		,(Select id_visibilidad
				from GESTORES_DEL_AIRE_ACONDICIONADO.dm_visibilidad
				where desc_tipo = @visualizacion)
		,(Select id_tipo_publi
				from GESTORES_DEL_AIRE_ACONDICIONADO.dm_tipo_publicacion
				where desc_tipo_public = @tipo_publicacion)
		,(Select id_rubro
				from GESTORES_DEL_AIRE_ACONDICIONADO.dm_rubro
				where desc_rubro = @rubro)
		,@usuario
Go

/* STORED PROCEDURE PARA CREAR UN NUEVO CLIENTE (CARGA TABLAS USUARIO, CLIENTE, Y ROLES_USUARIO)*/
Create Procedure GESTORES_DEL_AIRE_ACONDICIONADO.crear_usuario_cliente	(	 @username varchar(150)
																			,@password varchar(150)
																			,@rol varchar(100)	
																			,@desc_Apellido varchar(255)
																			,@desc_Nombre varchar(255)
																			,@desc_Dni varchar(18) --numeric(18,0)
																			,@desc_Mail varchar(255)
																			,@desc_Dom_Calle varchar(255)
																			,@desc_Nro_Calle varchar(18) --numeric(18,0)
																			,@desc_Piso varchar(18) --numeric(18,0)
																			,@desc_Depto varchar(50)
																			,@desc_Localidad varchar(45)
																			,@desc_Cod_Postal varchar(50)
																			,@desc_Telefono varchar(10) --numeric(10,0)
																			,@desc_Fecha_Nac varchar(20)	)--datetime	)
As
Declare @ultimo_id int;

Insert into GESTORES_DEL_AIRE_ACONDICIONADO.ft_usuario	(	 desc_username
															,desc_password
															,id_estado	)
Select	 @username
		,HASHBYTES('sha2_256', @password)
		,1

--Capturo el ultimo ID insertado
Set @ultimo_id = @@IDENTITY;

Insert into GESTORES_DEL_AIRE_ACONDICIONADO.rl_roles_usuarios	(	 id_usuario
																	,id_rol	)
Select	 @ultimo_id
		,id_rol
From GESTORES_DEL_AIRE_ACONDICIONADO.dm_rol
Where desc_rol = @rol


Insert into GESTORES_DEL_AIRE_ACONDICIONADO.lk_cliente	(	 id_usuario
															,desc_Apellido 
															,desc_Nombre 
															,desc_Dni 
															,desc_Mail 
															,desc_Dom_Calle 
															,desc_Nro_Calle 
															,desc_Piso 
															,desc_Depto 
															,desc_Localidad 
															,desc_Cod_Postal 
															,desc_Telefono 
															,desc_Fecha_Nac	)
Select	 @ultimo_id 
		,@desc_Apellido 
		,@desc_Nombre 
		,Convert(numeric(18,0), @desc_Dni) 
		,@desc_Mail 
		,@desc_Dom_Calle
		,Convert(numeric(18,0), @desc_Nro_Calle)
		,Convert(numeric(18,0), @desc_Piso) 
		,@desc_Depto 
		,@desc_Localidad
		,@desc_Cod_Postal 
		,Convert(numeric(10,0), @desc_Telefono) 
		,Convert(datetime, @desc_Fecha_Nac) 
GO

/* STORED PROCEDURE PARA CREAR UN NUEVO EMPRESA (CARGA TABLAS USUARIO, EMPRESA, Y ROLES_USUARIO)*/
Create Procedure GESTORES_DEL_AIRE_ACONDICIONADO.crear_usuario_empresa	(	 @username varchar(150)
																			,@password varchar(150)
																			,@rol varchar(100)	
																			,@desc_razon_social varchar(255)
																			,@desc_Mail varchar(255)
																			,@desc_Telefono varchar(10) --numeric(10,0)
																			,@desc_Fecha_Creacion varchar(50)
																			,@desc_Dom_Calle varchar(255)
																			,@desc_Nro_Calle varchar(18) --numeric(18,0)
																			,@desc_Piso varchar(18) --numeric(18,0)
																			,@desc_Depto varchar(50)
																			,@desc_Localidad varchar(45)
																			,@desc_Cod_Postal varchar(50)
																			,@desc_ciudad varchar(50)
																			,@desc_cuit varchar(20)	)
As
Declare @ultimo_id int;

Insert into GESTORES_DEL_AIRE_ACONDICIONADO.ft_usuario	(	 desc_username
															,desc_password
															,id_estado	)
Select	 @username
		,HASHBYTES('sha2_256', @password)
		,1

--Capturo el ultimo ID insertado
Set @ultimo_id = @@IDENTITY;

Insert into GESTORES_DEL_AIRE_ACONDICIONADO.rl_roles_usuarios	(	 id_usuario
																	,id_rol	)
Select	 @ultimo_id
		,id_rol
From GESTORES_DEL_AIRE_ACONDICIONADO.dm_rol
Where desc_rol = @rol

Insert into GESTORES_DEL_AIRE_ACONDICIONADO.lk_empresa	(	 id_usuario
															,desc_Razon_Social 
															,desc_Mail 
															,desc_Telefono 
															,desc_Fecha_Creacion
															,desc_Dom_Calle 
															,desc_Nro_Calle 
															,desc_Piso 
															,desc_Depto 
															,desc_Localidad 
															,desc_Cod_Postal 
															,desc_Ciudad
															,desc_Cuit
															,desc_nombre_contacto	)
Select	 
			 @ultimo_id
			,@desc_razon_social 
			,@desc_Mail 
			,Convert(numeric(10,0), @desc_Telefono)  
			,Convert(datetime, @desc_Fecha_Creacion )
			,@desc_Dom_Calle 
			,Convert(numeric(18,0), @desc_Nro_Calle)
			,Convert(numeric(18,0), @desc_Piso) 
			,@desc_Depto 
			,@desc_Localidad 
			,@desc_Cod_Postal 
			,@desc_ciudad 
			,@desc_cuit
			,''		
GO

/*PROCEDIMIENTO NECESARIO PARA LOGEO Y SEGURIDAD*/
Create Procedure GESTORES_DEL_AIRE_ACONDICIONADO.logearse	(	 @user varchar(150)
																,@pass varchar(150)	)
As
Declare @usuario int = 0;
Declare @estado int = 0;

Select	@usuario = us.id_usuario,
		@estado = us.id_estado
From GESTORES_DEL_AIRE_ACONDICIONADO.ft_usuario us
Where us.desc_username = @user

if (@usuario = 0)
	Select 'invalido' as mensaje
else
	if (@estado = 2)
		Select 'inhabilitado' as mensaje
	else
		if not exists (Select 'existe' from GESTORES_DEL_AIRE_ACONDICIONADO.ft_usuario us
						where us.id_usuario = @usuario
						  and us.desc_password = HASHBYTES('SHA2_256', @pass)	)
			Begin
			Insert into GESTORES_DEL_AIRE_ACONDICIONADO.log_ingresos	(	 id_usuario
																			,desc_fecha_log	)
			Values	(	 @usuario
						,Getdate()	)

			Select 'incorrecto' as mensaje
			End
		else
			Begin
			Delete from GESTORES_DEL_AIRE_ACONDICIONADO.log_ingresos
			Where id_usuario = @usuario

			Select 'correcto' as mensaje
			End
Go

/* TRIGGER CONTROL DE INGRESOS INCORRECTOS */
Create Trigger GESTORES_DEL_AIRE_ACONDICIONADO.controlar_ingresos
On GESTORES_DEL_AIRE_ACONDICIONADO.log_ingresos
After insert
As
Declare @id int;
Declare @cont int;

Select @id = id_usuario from inserted

Set @cont = (Select Count(1) from GESTORES_DEL_AIRE_ACONDICIONADO.log_ingresos
						where id_usuario = @id	)

If (@cont = 3)
Begin
	Update GESTORES_DEL_AIRE_ACONDICIONADO.ft_usuario
	Set id_estado = 2
	Where id_usuario = @id
End
Go

/* TRIGGER SUMAR TOTALES PARA FACTURAS */
Create Trigger GESTORES_DEL_AIRE_ACONDICIONADO.sumar_total
On GESTORES_DEL_AIRE_ACONDICIONADO.ft_item
After insert
As
Declare @id numeric(18,0);
Declare @monto_total numeric(18,2);

Select @id = id_factura from inserted

Select @monto_total = SUM(it.desc_item_monto)
From GESTORES_DEL_AIRE_ACONDICIONADO.ft_factura fa
left join GESTORES_DEL_AIRE_ACONDICIONADO.ft_item it
	on fa.id_factura = it.id_factura
Where it.id_factura = @id

Update GESTORES_DEL_AIRE_ACONDICIONADO.ft_factura
Set desc_total = @monto_total
Where id_factura = @id

Go





/*

Select * from GESTORES_DEL_AIRE_ACONDICIONADO.log_ingresos

Select * from GESTORES_DEL_AIRE_ACONDICIONADO.ft_usuario

Insert into GESTORES_DEL_AIRE_ACONDICIONADO.ft_usuario	(	 desc_username
															,desc_password
															,id_estado	)
Select	 'admin'
		,HASHBYTES('sha2_256', 'admin')
		,1

Insert into GESTORES_DEL_AIRE_ACONDICIONADO.rl_roles_usuarios
values (96,1)

Select * from GESTORES_DEL_AIRE_ACONDICIONADO.rl_roles_usuarios
*/








